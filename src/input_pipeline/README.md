# AOSLO Pipeline for Video to Image registration

## How to use

If you need to install Anaconda and create your environment to code for the first time, see [here](../README.pdf).

Run this pipeline by running the following command from this current directory (`cd src/InputData_Pipe`):

```bash
python Start_AOImgProc_Pipe.py
```

or click on the **start** button from Spyder when the file *Start_AOImgProc_Pipe.py* is open.

This will launch the **fully automatic** pipeline to get images from the videos with help of the BostonMicromachines (BMC) software. Be sure to have the specific files in the correct folder as stated in the Configs files and in Input/Output files management. The pipeline needs to have the mouse freed, so please don't use your computer while the pipeline is running, just wait for resulting files to be stacked in the output directory.

## Configs files

In the *Configs* folder you have the specification of the configuration files if you want to run this automation on the Virtual Machine (*config_VM.txt*) or on your local computer (*config_laptop.txt*). The usual use of this pipeline is to go in the Virtual Machine (**SFHVAOSLO01** with account **ADI\aoslo** and the specific password (ask Mattia)). Normally the config file should not be modified but if you need to, the meaning of the config files lines are the following:

* **[os] __powerShell** = location of the Windows PowerShell executable that is used to run software for video to image registration.
* **[Pipeline] __ActivationTimeInterval_seconds** = time in seconds that the autmation has to wait between actions to let files getting moved in different folder
* **[Pipeline] __RestAfterRun_seconds** = time in seconds tbefore restarting the automation
* **[AOImgProc] __WaitingRoom_AOImageProc** = folder to put temporary the files when they are passed through the BMC software
* **[AOImgProc] __AOImageProc_Home** = parent folder of the subdirectory containing all the files
* **[AOImgProc] __AOImageProc_InFolder** = folder to put the videos that needs to be registered into images
* **[AOImgProc] __AOImageProc_OutFolder** = folder where the resulting images will be saved
* **[AOImgProc] __UI_automationTool** = path of the AutoIt scripts that is use to click automatically on the software so that manually intervention is not needed
* **[AOImgProc] __UI_automationScript** = path where the AutoIT scripts is
* **[AOImgProc] __AOImgProc_retriesOnFailure** = number of retries when there is a bug during the automation process
* **[AOImgProc] __modalities** = the modalities to process
* **[Montaging] __Montaging_InFolder** = folder where the image files get outputed once they are done being processed.

## Input/Output files management

The videos that we want need to be process into images must be put in the **__WaitingRoom_AOImageProc** folder (*P:\AOSLO\_automation\__WaitingRoom_AOImageProc*). If you run the pipeline and the files are not finished being copy pasted there, no worries the pipeline will wait until the transfer is complete.

The output images will be found in the **__Montaging_InFolder** folder (*P:\AOSLO\_automation\__Montaging_InFolder*) where the **avg** image is the image contianing the result of the video registration for each modality and is the image to be used for the PostProcessing part of the pipeline. The **std** image is the standard deviation of the video, representing how much the subject moved during the video captured and could be used to access image acquisition quality (but not used for now).

## Program to install to use this Input pipeline (done in the VM)

For the pipeline to run correctly, you need to have the BMC software install, the [AutoIT](https://www.autoitscript.com/site/autoit/downloads/) software donwloaded and [Windows Power Automate](https://learn.microsoft.com/en-us/power-automate/desktop-flows/install) installed with the Microsoft account *mattia.tomasoni@fa2.ch* connected (ask Mattia for the password) and the *AO_ImageProcessing* flow in the first position (because we run a script to automatically run the flow).

## Result of the pipeline

You can check the log file in the *Logs* folder to see if something wrong happened. mostly if some files are missing in the output folder.

## Details of the video to image registration algortihm

To process the video imaging data generated by the AOSLO device, a pipeline that included a video-to-image registration software had been deployed on a virtual machine at the hospital. The pipeline was registering one modality at a time. This limitation was inducing a shift between Confocal and CalculatedSplit that was problematic for our analysis (which required the two to be perfectly aligned): in fact, our methodology was based on locating cone centers found on CalculatedSplit, then transferring those coordinate locations to the Confocal modality. I thus modified the pipeline in order to process images from all modalities at once. I also modified the pipeline making it fully automatic, in order for the doctor capturing the AOSLO videos to get the registered images directly. Indeed, the video-to-image registration software is proprietary and access to the source code is restricted. Thus, we developed a GUI automation routine carrying out the video registration process. Once the AOSLO videos have been captured, they are moved to a virtual machine where they are automatically processed:
an AutoIt v3 script (i.e., a freeware BASIC-like scripting language) is used to launch a Windows Power Automate routine (i.e., a Microsoft tool to automate interaction with the Windows GUI). This routine runs the registration software on each video recording. Thanks to my improvement, registration of all modalities happens at once.
This increases reliability in video-to-image registration and saves time for the AOSLO perators. An imaging session without supporting registration pipeline would have taken several hours of manual postprocessing (depending on the imaging protocol). Now, the whole process runs in parallel to image acquisition with no need for human intervention.
