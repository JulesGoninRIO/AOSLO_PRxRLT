# Cone Density Analysis Notebooks Documentation

## Overview

This documentation covers two complementary analysis notebooks that perform statistical analysis and visualization of cone photoreceptor density relationships:

- **CDxRLT_analysis.ipynb**: Comprehensive analysis of cone density vs retinal layer thickness relationships
- **correlation_analysis.ipynb**: Regional correlation analysis and foveal shape parameter correlations

Both notebooks operate as terminal analysis components of the cone density pipeline, consuming outputs from the density analysis pipeline manager and layer processing modules to generate research-ready statistical results and visualizations.

---

## Section 1: Common Components

### Shared Data Structures and Functions

Both notebooks utilize identical data structures and several shared analysis functions that form the foundation of the cone density analysis workflow.

### Common Data Structures

#### SubjectData Class
The `SubjectData` dataclass serves as the primary container for all subject-specific measurements across both notebooks:

**Identifier Fields:**
- `name`, `pid`, `nb`, `session`: Subject and session identification

**Cone Density Parameters:**
- `width_nas/tem/inf/sup`: Bilateral model width parameters for each meridian
- `max_slope_nas/tem/inf/sup`: Peak slope measurements for each meridian
- `density_X/Y`: Smoothed density profiles along horizontal/vertical meridians
- `density_fit_X/Y`: Fitted bilateral model density profiles
- `nb_cones/nb_cones_fit`: Total cone count within defined radius

**Foveal Shape Parameters:**
- `oct_bump_X/Y`: Curvature coefficients from 3D polynomial fit
- `oct_width_X/Y`: Foveal pit width measurements
- `oct_depth`: Maximum foveal pit depth
- `oct_max_slope/oct_flatness`: Shape characterization parameters

**Layer Thickness Series:**
- Individual pandas Series for each layer (`rnfl_X/Y`, `gcl_ipl_X/Y`, `onl_X/Y`, etc.)
- Indexed by eccentricity values from -10° to +10°

**Subject Characteristics:**
- `age`, `axial_length`, `spherical_equiv`, `sex`: Demographic and ocular parameters

#### FoveaParams Class
The `FoveaParams` dataclass structures 3D foveal shape fitting results:
- Polynomial coefficients (A00, A10, A01, A20, A02, A11) from surface fitting
- Geometric parameters (center coordinates, width, depth, volume)
- Subject identification and metadata

### Common Input Dependencies

Both notebooks require identical input files generated by upstream pipeline components:

#### From Density Analysis Pipeline (`density_analysis_new/`)
- **`densities.csv`**: Fitted cone density parameters and smoothed density profiles
- **`densities_raw_x.csv`** / **`densities_raw_y.csv`**: Raw density measurements from Yellott's method
- **`results.csv`**: Combined density and layer thickness measurements

#### From Layer Processing (`layer_new/`)
- **`fovea_3d_fitted_params.csv`**: 3D foveal shape parameters

#### From Subject Metadata
- **`processed.txt`**: Subject/session lookup table
- **`DATA_HC+DM.xlsx`**: Baseline characteristics database

### Shared Analysis Functions

#### `preprocess_functional_feature(data: np.ndarray, standardization: str = 'inter') -> np.ndarray`
Standardizes functional data (density/thickness vs eccentricity) using:
- **Inter-individual** (`'inter'`): Z-score normalization across subjects at each eccentricity
- **Intra-individual** (`'intra'`): Z-score normalization within each subject across eccentricities

#### `get_nb_cones(ecc: np.ndarray, dens_X: pd.Series, dens_Y: pd.Series, radius: float, smoothen: bool = True) -> float`
Integrates cone density over a circular region by:
1. Interpolating density profiles radially between X and Y measurements
2. Applying optional Gaussian smoothing (σ=4)
3. Numerical integration using trapezoidal rule with polar coordinate conversion

#### `integrate_cone_density_circle(...) -> Tuple[...]`
Comprehensive circular integration function that:
1. Creates polar coordinate grid (r, θ) for integration
2. Interpolates density values from X and Y meridian measurements
3. Combines measurements using angular weighting: `density(r,θ) = density_X(r)cos²(θ) + density_Y(r)sin²(θ)`
4. Performs numerical integration with Simpson's rule

#### `extract_fovea_data(base_path: str) -> List[FoveaParams]`
Recursively searches subject directories for foveal parameter CSV files and populates FoveaParams objects with error handling for missing data.

---

## Section 2: CDxRLT Analysis Notebook

### Notebook Flow

The CDxRLT analysis notebook follows a structured pipeline focused on cone density vs retinal layer thickness relationships:

1. **Data Loading**: Aggregates processed density and thickness data from all subjects
2. **Data Structure Population**: Organizes subject-specific measurements into standardized data structures
3. **Density Analysis**: Performs cone density integration, normalization, and comparative analysis
4. **Statistical Correlation**: Executes intra-individual and inter-individual correlation analyses
5. **Eccentricity-wise Analysis**: Computes pointwise correlations across retinal eccentricities
6. **Visualization Generation**: Creates heatmaps, cross-sectional plots, and circular retinal representations

5. **Eccentricity-wise Analysis**: Computes pointwise correlations across retinal eccentricities
6. **Visualization Generation**: Creates heatmaps, cross-sectional plots, and circular retinal representations

### CDxRLT-Specific Functions

#### `get_gcl_width(gcl: pd.Series) -> Tuple[float, float]`
Analyzes GCL+IPL thickness profiles to extract:
1. **Pit width**: Distance between 20% depth threshold points
2. **Minimum thickness**: Fitted minimum from parabolic model of lowest 10 points
Uses adaptive smoothing and peak detection to handle noisy thickness data.

#### `compute_correlations_eccwise(direction: Direction, eccs: np.ndarray, correlation_fun: Callable) -> Dict[str, Tuple[np.ndarray]]`
Computes pointwise correlations between cone density and each retinal layer:
1. Preprocesses functional data with inter-individual standardization
2. Iterates over each eccentricity position
3. Applies correlation function (default: Spearman's rank correlation)
4. Returns correlation coefficients and p-values for each layer

#### `mixedlm(cd: np.ndarray, lt: np.ndarray, pids: np.ndarray, eccs: np.ndarray, standardization: str = 'inter') -> Tuple[float, float]`
Performs mixed linear modeling using statsmodels:
- Accounts for subject-level random effects
- Optional eccentricity-based random slopes for intra-individual analysis
- Returns fixed effect coefficient and p-value for cone density predictor

#### `plot_slice_correlation(layer_name: str, degree: float | Iterable, direction: Direction, ...)`
Generates correlation scatter plots with:
1. Mixed linear model fitting for multi-eccentricity data
2. Quadrant-based significance testing using binomial tests
3. Statistical annotation (Spearman, Pearson, Mixed LM coefficients)
4. Standardization handling for inter/intra-individual comparisons

#### `plot_correlations_eccwise(results: Dict, eccs: np.ndarray, direction: str, ...)`
Creates eccentricity-wise correlation plots featuring:
- Retinal region background gradients (foveola, fovea, parafovea, perifovea)
- Significance-based alpha transparency
- Multiple layer overlay with distinct colormaps
- Smoothing options (Gaussian, Savitzky-Golay, moving average)

#### `plot_cross_heatmap(results_x: Dict, results_y: Dict, eccs: np.ndarray, ...)`
Generates cross-shaped heatmaps representing:
- Horizontal meridian correlations on X-axis bars
- Vertical meridian correlations on Y-axis bars
- Tapered center region with configurable taper styles
- Significance dimming overlay for p-value thresholding
- Circular region boundary overlays

### CDxRLT Analysis Methodologies

#### Density Integration Comparison
The notebook implements Zhang et al. (2015) integration methodology for validation:
1. Polar coordinate integration over circular regions
2. Radial interpolation between orthogonal meridian measurements  
3. Statistical comparison with literature values
4. Cumulative integration analysis as function of eccentricity

#### Intra-Individual vs Inter-Individual Analysis
**Intra-Individual Analysis:**
- Focuses on within-subject relationships between density and thickness
- Uses within-subject standardization to remove individual baseline differences

**Inter-Individual Analysis:** 
- Examines between-subject variations in density-thickness relationships
- Uses across-subject standardization at each eccentricity

#### Covariate Regression Analysis
Advanced preprocessing includes covariate removal via linear regression:
1. **Mixed Linear Modeling**: Accounts for subject-level random effects
2. **Residualization**: Removes age, axial length, and other covariate effects
3. **Diagnostic Plotting**: Residual analysis and correlation matrix visualization

---

## Section 3: Correlation Analysis Notebook

### Notebook Flow

The correlation analysis notebook focuses on regional and morphological correlations:

1. **Setup and Data Loading**: Similar data loading as CDxRLT notebook with additional regional definitions
2. **Regional Correlation Analysis**: Computes correlations between cone density measurements across different retinal regions
3. **Foveal Shape Parameter Analysis**: Correlates 3D foveal morphology with cone density metrics
4. **Advanced Statistical Testing**: Implements comprehensive significance testing with multiple comparison corrections
5. **Correlation Matrix Visualization**: Generates publication-ready correlation heatmaps

### Correlation Analysis-Specific Functions

#### `corr_sig(df: pd.DataFrame, drop=['nb']) -> Tuple[np.ndarray, np.ndarray]`
Computes correlation matrices with significance testing:
- Calculates Pearson correlation coefficients between all numeric variables
- Generates corresponding p-value matrix for significance assessment
- Returns both correlation and p-value matrices for visualization

#### `get_cd_on_range(left, right, direction: Direction)`
Extracts mean cone density values over specified eccentricity ranges:
- Filters eccentricity indices within specified bounds
- Computes mean density across the range for each subject
- Supports both X and Y directional measurements

#### `calculate_pvalues(df: pd.DataFrame) -> pd.DataFrame`
Computes p-values for correlation matrices using Spearman's rank correlation:
- Handles missing data through pairwise deletion
- Returns formatted p-value matrix for annotation
- Integrates with significance marker system

#### `significance_marker(pval: float) -> str`
Converts p-values to significance notation:
- `***` for p < 0.001
- `**` for p < 0.01  
- `*` for p < 0.05
- Empty string for non-significant results

### Foveal Shape Analysis Functions

#### `calculate_peak_width(density_values, positions, threshold_percent=50) -> float`
Calculates peak width at specified percentage of maximum value:
- Uses linear interpolation for precise threshold crossing detection
- Handles both full-width-half-maximum (50%) and custom thresholds
- Returns width measurement in spatial units (degrees or mm)

#### `calculate_fovea_volume(params: FoveaParams, radius_start: float, radius_end: float, num_points: int = 1000) -> float`
Calculates foveal volume from 3D shape parameters:
1. Defines height function from polynomial and Gaussian components
2. Converts to polar coordinates for circular integration
3. Performs numerical double integration over specified radius range
4. Returns volume measurement for correlation with cone density metrics

#### `calculate_directional_slopes(params, distance=0.1) -> Dict`
Computes foveal slopes in four cardinal directions:
- Calculates height differences at specified distance from foveal center
- Returns slopes for temporal, nasal, superior, and inferior directions
- Uses 3D foveal model for precise slope calculations

#### `create_correlation_matrix(fovea_params_list, region_dict) -> Tuple`
Creates comprehensive correlation matrices between foveal parameters and regional cone density:
1. Converts FoveaParams objects to DataFrame format
2. Processes regional cone density data with proper numeric conversion
3. Merges datasets on subject identifiers with error handling
4. Computes Spearman correlations with significance testing
5. Returns correlation matrix, merged data, and formatted annotations

#### `analyze_foveal_shape_and_cone_density(fovea_data, retinal_regions, integration_data) -> Tuple`
Main wrapper function for complete foveal shape analysis:
1. Calculates foveal volumes for all defined retinal regions
2. Correlates volume measurements with cone density integration data
3. Generates publication-ready correlation matrix visualizations
4. Returns correlation results and processed data for further analysis

### Regional Analysis Methodology

#### Retinal Region Definition
The notebook defines anatomically meaningful regions:
- **Foveola**: 0° to 0.6° (central avascular zone)
- **FAZ**: 0.6° to 0.8° (foveal avascular zone border)
- **Fovea**: 0.8° to 2.8° (foveal region)
- **Parafovea**: 2.8° to 4.16° (parafoveal region)
- **Perifovea**: 4.16° to 10° (perifoveal region)

#### Integration Data Processing
Regional cone density values are computed through:
1. Circular integration within each region boundary
2. Polar coordinate interpolation between X and Y meridian measurements
3. Statistical aggregation across subjects for population analysis

### Advanced Correlation Features

#### Multi-threshold Peak Analysis
The notebook implements peak width calculations at multiple thresholds (20%, 50%, etc.) to characterize:
- Peak sharpness variations across subjects
- Relationship between peak geometry and total cone count
- Correlation with foveal morphological parameters

#### 3D Foveal Shape Integration
Combines OCT-derived 3D foveal shape parameters with cone density measurements:
- Polynomial surface fitting coefficients (A00, A10, A01, A20, A02, A11)
- Gaussian pit characteristics (depth, width, center coordinates)
- Derived morphological metrics (volume, slopes, flatness)

---

## Integration with Pipeline Architecture

Both notebooks represent terminal analysis components of the cone density pipeline, consuming:
- Montaged AOSLO imagery via `MontageMosaic` objects
- Fitted density profiles from `YellottConeDensityCalculator`
- Layer thickness measurements from `LayerThicknessCalculator`
- Correlation results from `DensityLayerAnalysis`

The analysis results support research conclusions with comprehensive statistical validation of:
1. **CDxRLT Notebook**: Cone density-layer thickness relationships across retinal eccentricities
2. **Correlation Notebook**: Regional cone density patterns and foveal morphology correlations

## Technical Implementation Notes

### Performance Considerations
- Extensive use of numpy vectorization for efficiency
- pandas DataFrame operations for data manipulation
- scipy statistical functions for robust correlation computation
- Memory-efficient processing of large subject cohorts (33 subjects × 201 eccentricities)

### Error Handling
- Graceful handling of missing data through NaN-aware statistical functions
- Adaptive smoothing parameters for noisy profiles
- Robust fitting procedures with outlier detection
- File I/O error recovery for batch processing

### Data Validation
- OCT alignment validation using foveal center detection
- Exclusion criteria for tilted OCT acquisitions (12 of 45 subjects excluded)
- Quality control checks for density fitting convergence
- Statistical assumption validation for correlation analyses